{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
"parameters": {
        "_artifactsLocation": {
            "type": "string"
        },
        "_artifactsLocationSasToken": {
            "type": "securestring"
        },
        "sqlServerName":{
            "type": "string"
        },
        "sqlDBName":{
            "type": "string"
        },
        "AD_admin_name":{
            "type": "string"
        },
        "AD_admin_objectid":{
            "type": "string"
        },
        "sqladminLogin":{
            "type": "string"
        },
        "sqladminLoginPassword":{
            "type": "securestring"
        },
        "ProjectCodeName":{
            "type":"string"
        },
        "createdby":{
            "type":"string",
            "defaultValue" : ""
        },
        "firewall_rule1":{
          "type": "string"
        },
        "firewall_rule2":{
          "type": "string"
        },
        "firewall_rule3":{
          "type": "string"
        },
        "firewall_rule4":{
          "type": "string"
        },
        "firewall_rule5":{
          "type": "string" 
        },
        "deploymentPrincipalObjectId": {
            "type": "string"
        },
        "allowedIpAddresses": {
            "type": "array"
        },
        "keyVaultName": {
            "type": "string"
        },
        "AppInsightsName": {
            "type": "string"
        },
        "functionAppServicePlan": {
            "type": "string"
        },
        "WebAppUIName": {
            "type": "string"
        },      
        "functionAppName": {
            "type": "string"
        },
        "WafPolicyName": {
            "type": "string"
        },
        "FrontDoorName": {
            "type": "string"
        },
        "FuncAppRegistrationSecret": {
            "type": "string"
        },
        "FuncAppRegistrationAppId": {
            "type": "string"
        }  
        
    }, 
    "variables": {
        "tenantId": "[subscription().tenantId]"
    },
    "resources": [
        {
            "name": "sqlserver-database",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('_artifactsLocation'),'/Artifacts/Templates/sql_server.json.',parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "sqlServerName": {
                        "value": "[parameters('sqlServerName')]"
                    },
                    "sqlDbName": {
                        "value": "[parameters('sqlDBName')]"
                    },
                    "sqlServerAdminLogin": {
                        "value": "[parameters('sqladminLogin')]"
                    },
                    "sqlServerAdminLoginPassword": {
                        "value": "[parameters('sqladminLoginPassword')]"
                    },
                    "aadTenantId": {
                        "value": "[variables('tenantId')]"
                    },
                    "aadAdminLogin": {
                        "value": "[parameters('AD_admin_name')]"
                    },
                    "aadAdminObjectId": {
                        "value": "[parameters('AD_admin_objectid')]"
                    },
                    "allowedIpAddresses": {
                        "value": "[parameters('allowedIpAddresses')]"
                    },
                    "firewall_rule1":{
                        "value": "[parameters('firewall_rule1')]"  
                    },
                    "firewall_rule2":{
                        "value": "[parameters('firewall_rule2')]"
                    },
                    "firewall_rule3":{
                        "value": "[parameters('firewall_rule3')]" 
                    },
                    "firewall_rule4":{
                        "value": "[parameters('firewall_rule4')]" 
                    },
                    "firewall_rule5":{
                        "value": "[parameters('firewall_rule5')]" 
                    }
                }
            }
        },
        {
            "name": "keyvault",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('_artifactsLocation'),'/Artifacts/Templates/azurekeyvault.json',parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters":{
                    "keyVaultName": {
                        "value" : "[parameters('keyVaultName')]"
                    },
                    "project":{
                        "value":"[parameters('ProjectCodeName')]"
                    },
                    "deploymentPrincipalObjectId":{
                        "value":"[parameters('deploymentPrincipalObjectId')]"
                    }
                }
            }
        },
        {
            "name": "app-insights",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('_artifactsLocation'),'/Artifacts/Templates/azureappinsights.json',parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters":{
                    "appInsightName": {
                        "value" : "[parameters('AppInsightsName')]"
                    },
                    "project":{
                        "value":"[parameters('ProjectCodeName')]"
                    }
                }
            }
        },
        {
            "name": "app-service-plan",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('_artifactsLocation'),'/Artifacts/Templates/appServicePlan.json', parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "appServicePlanName": {
                        "value": "[parameters('functionAppServicePlan')]"
                    },
                    "project":{
                        "value":"[parameters('ProjectCodeName')]"
                    }
                }
            }
        },
        {
            "name": "function-app",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'app-insights')]",
                "[resourceId('Microsoft.Resources/deployments', 'app-service-plan')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('_artifactsLocation'), '/Artifacts/Templates/azurefunctionapp.json', parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "functionAppName": {
                        "value": "[parameters('functionAppName')]"
                    },
                    "WebAppName": {
                        "value": "[parameters('WebAppUIName')]"
                    },
                    "appServicePlanName": {
                        "value": "[parameters('functionAppServicePlan')]"
                    },
                    "appInsightsName": {
                        "value": "[parameters('appInsightsName')]"
                    },
                    "project":{
                        "value":"[parameters('ProjectCodeName')]"
                    },
                    "FuncAppRegistrationSecret":{
                        "value":"[parameters('FuncAppRegistrationSecret')]"
                    },
                    "FuncAppRegistrationAppId":{
                        "value":"[parameters('FuncAppRegistrationAppId')]"
                    }
                }
            }
        },
        {
            "name": "web-app",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'app-insights')]",
                "[resourceId('Microsoft.Resources/deployments', 'app-service-plan')]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('_artifactsLocation'), '/Artifacts/Templates/azurewebapp.json', parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "webAppName": {
                        "value": "[parameters('WebAppUIName')]"
                    },
                    "appServicePlanName": {
                        "value": "[parameters('functionAppServicePlan')]"
                    },
                    "appInsightsName": {
                        "value": "[parameters('appInsightsName')]"
                    }
                }
            }
        },
        {
            "name": "AzureWafPolicy",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('_artifactsLocation'),'/Artifacts/Templates/azurewafpolicy.json',parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters":{
                    "WafPolicyName":{
                        "value": "[parameters('WafPolicyName')]"
                    },
                    "project":{
                        "value":"[parameters('ProjectCodeName')]"
                    }
                }
            }
        },
        {
            "name": "AzureFrontDoor",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-04-01",
            "dependsOn": [
                    "[resourceId('Microsoft.Resources/deployments', 'app-service-plan')]",
                    "[resourceId('Microsoft.Resources/deployments', 'AzureWafPolicy')]"
                ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[concat(parameters('_artifactsLocation'),'/Artifacts/Templates/azurefrontdoor.json',parameters('_artifactsLocationSasToken'))]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters":{
                    "FrontDoorname":{
                        "value": "[parameters('FrontDoorName')]"
                    },
                    "frontend_webapp":{
                        "value" : "[parameters('WebAppUIName')]"
                    },
                    "backend_webapp":{
                        "value" : "[parameters('functionAppName')]"
                    },
                    "WafPolicyName":{
                        "value": "[parameters('WafPolicyName')]"
                    },
                    "project":{
                        "value":"[parameters('ProjectCodeName')]"
                    }
                }
            }
        }
    ],
    "outputs": {}
}